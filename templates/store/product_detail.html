{% extends 'base.html' %}
{% load i18n %}

{% block title %}{{ product.name }} - {{ site_settings.business_name }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Product Image -->
        <div class="col-md-6 mb-4">
            <img src="{{ product.image.url }}" class="img-fluid rounded" alt="{{ product.name }}">
        </div>
        
        <!-- Product Details -->
        <div class="col-md-6">
            <h1 class="mb-3">{{ product.name }}</h1>
            
            <!-- Rating -->
            <div class="rating mb-3">
                {% for i in "12345" %}
                    {% if i|add:"0" <= product.rating %}
                        <i class="fas fa-star"></i>
                    {% else %}
                        <i class="far fa-star"></i>
                    {% endif %}
                {% endfor %}
                <span class="ms-2">({{ product.review_count }} {% trans 'reviews' %})</span>
            </div>
            
            <!-- Price -->
            <div class="mb-4">
                {% if product.discount_price %}
                    <h2 class="product-price">{{ product.discount_price }} SR</h2>
                    <span class="text-muted text-decoration-line-through fs-5">{{ product.price }} SR</span>
                    <span class="badge bg-danger ms-2">-{{ product.discount_percentage }}%</span>
                {% else %}
                    <h2 class="product-price">{{ product.price }} SR</h2>
                {% endif %}
            </div>
            
            <!-- Description -->
            <p class="mb-4">{{ product.description }}</p>
            
            <!-- Stock Status -->
            <div class="mb-4">
                {% if product.stock > 0 %}
                    <span class="badge bg-success">{% trans 'In Stock' %}</span>
                {% else %}
                    <span class="badge bg-danger">{% trans 'Out of Stock' %}</span>
                {% endif %}
            </div>
            
            <!-- Add to Cart Form -->
            {% if user.is_authenticated %}
                <form method="post" action="{% url 'add_to_cart' product.id %}" class="mb-4">
                    {% csrf_token %}
                    <div class="input-group mb-3" style="max-width: 200px;">
                        <button class="btn btn-outline-secondary" type="button" id="decreaseQty">-</button>
                        <input type="number" name="quantity" id="quantity" class="form-control text-center" value="1" min="1" max="{{ product.stock }}">
                        <button class="btn btn-outline-secondary" type="button" id="increaseQty">+</button>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg w-100" {% if product.stock == 0 %}disabled{% endif %}>
                        <i class="fas fa-shopping-cart"></i> {% trans 'Add to Cart' %}
                    </button>
                </form>
            {% else %}
                <div class="alert alert-info">
                    {% trans 'Please' %} <a href="{% url 'admin:login' %}">{% trans 'login' %}</a> {% trans 'to add items to cart' %}
                </div>
            {% endif %}
            
            <!-- Share -->
            <div class="mt-4">
                <h6>{% trans 'Share' %}:</h6>
                <a href="https://www.facebook.com/sharer/sharer.php?u={% request.build_absolute_uri %}" class="btn btn-sm btn-primary me-2">
                    <i class="fab fa-facebook"></i>
                </a>
                <a href="https://twitter.com/intent/tweet?url={% request.build_absolute_uri %}" class="btn btn-sm btn-info me-2">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="https://wa.me/?text={% request.build_absolute_uri %}" class="btn btn-sm btn-success">
                    <i class="fab fa-whatsapp"></i>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Reviews Section -->
    <div class="row mt-5">
        <div class="col-md-8">
            <h3>{% trans 'Reviews' %}</h3>
            
            {% if user.is_authenticated %}
                <!-- Add Review Form -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">{% trans 'Add Your Review' %}</h5>
                        <form method="post" action="{% url 'add_review' product.id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label">{% trans 'Rating' %}</label>
                                <div class="rating-input">
                                    {% for i in "12345" %}
                                        <input type="radio" name="rating" value="{{ i }}" id="star{{ i }}" style="display: none;">
                                        <label for="star{{ i }}" style="cursor: pointer; color: #ddd; font-size: 2rem;">
                                            <i class="fas fa-star"></i>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="comment" class="form-label">{% trans 'Comment' %}</label>
                                <textarea class="form-control" id="comment" name="comment" rows="4" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">{% trans 'Submit Review' %}</button>
                        </form>
                    </div>
                </div>
            {% endif %}
            
            <!-- Reviews List -->
            {% if reviews %}
                {% for review in reviews %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-subtitle mb-2">{{ review.user.get_full_name|default:review.user.username }}</h6>
                                    <div class="rating mb-2">
                                        {% for i in "12345" %}
                                            {% if i|add:"0" <= review.rating %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                            </div>
                            <p class="card-text">{{ review.comment }}</p>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info">
                    {% trans 'No reviews yet. Be the first to review this product!' %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Rating input
    const ratingInputs = document.querySelectorAll('.rating-input input[type="radio"]');
    const ratingLabels = document.querySelectorAll('.rating-input label');
    
    ratingLabels.forEach(label => {
        label.addEventListener('click', function() {
            ratingLabels.forEach(l => l.style.color = '#ddd');
            for (let i = 0; i < Array.from(ratingLabels).indexOf(this) + 1; i++) {
                ratingLabels[i].style.color = '#ffc107';
            }
        });
    });
    
    // Quantity controls
    document.getElementById('increaseQty').addEventListener('click', function() {
        const input = document.getElementById('quantity');
        input.value = parseInt(input.value) + 1;
    });
    
    document.getElementById('decreaseQty').addEventListener('click', function() {
        const input = document.getElementById('quantity');
        if (parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
        }
    });
</script>
{% endblock %}
